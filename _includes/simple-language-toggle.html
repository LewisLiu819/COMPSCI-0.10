{% include language-nav-filter.html %}

{% assign current_lang = page.lang | default: 'zh' %}
{% assign current_path = page.url %}

<div class="language-toggle">
  {% if current_lang == 'zh' %}
    {% comment %} Convert Chinese path to English path {% endcomment %}
    {% if current_path == '/' %}
      {% assign target_url = '/en/' %}
    {% elsif current_path contains '/zh/' %}
      {% assign target_url = current_path | replace: '/zh/', '/en/' %}
    {% elsif current_path contains '/lessons/' %}
      {% comment %} Old lessons path - redirect to English home {% endcomment %}
      {% assign target_url = '/en/' %}
    {% else %}
      {% assign target_url = '/en/' %}
    {% endif %}
    <a href="{{ target_url }}">English</a>
  {% else %}
    {% comment %} Convert English path to Chinese path {% endcomment %}
    {% if current_path == '/en/' %}
      {% assign target_url = '/' %}
    {% elsif current_path contains '/en/' %}
      {% assign target_url = current_path | replace: '/en/', '/zh/' %}
    {% else %}
      {% assign target_url = '/' %}
    {% endif %}
    <a href="{{ target_url }}">中文</a>
  {% endif %}
</div>

<script>
// Navigation filtering by language
document.addEventListener('DOMContentLoaded', function() {
  const currentLang = '{{ current_lang }}';

  function hideNavItem(element) {
    if (element) {
      element.style.display = 'none';
    }
  }

  function filterNavigation() {
    // Get all navigation links
    const navLinks = document.querySelectorAll('.nav-list a[href]');

    navLinks.forEach(function(link) {
      const href = link.getAttribute('href');
      if (!href || href.startsWith('http') || href.startsWith('#')) return;

      const isEnglish = href.startsWith('/en/');
      const isChinese = href.startsWith('/zh/') || href.startsWith('/lessons/') || href === '/';
      const isInternal = href.startsWith('/');

      if (!isInternal) return;

      // Hide navigation items that don't match current language
      if (currentLang === 'en' && !isEnglish) {
        hideNavItem(link.closest('li'));
      } else if (currentLang === 'zh' && isEnglish) {
        hideNavItem(link.closest('li'));
      }
    });

    // Clean up empty parent containers
    setTimeout(function() {
      const allNavItems = document.querySelectorAll('.nav-list li');
      allNavItems.forEach(function(item) {
        // Check if this item has any visible children or links
        const visibleChildren = item.querySelectorAll('li:not([style*="display: none"]), a[href]:not([style*="display: none"])');
        const hasDirectLink = item.querySelector(':scope > a[href]');
        const isDirectLinkVisible = hasDirectLink && hasDirectLink.style.display !== 'none';

        // If no visible children and no visible direct link, hide the parent
        if (visibleChildren.length === 0 && !isDirectLinkVisible) {
          hideNavItem(item);
        }
      });
    }, 50);
  }

  // Run filtering
  filterNavigation();
});
</script>
